<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç‚ºä»€éº¼åŠå¤œä¸ç¡è¦º</title>
<style>
:root{--bg:#0b0f14;--fg:#eaf2ff;--border:#1a2230}
html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:"Noto Sans TC","Microsoft JhengHei",system-ui,sans-serif}
body{display:flex;flex-direction:column;height:100vh}
header{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
button,select,input[type=file],input[type=range],input[type=checkbox]{background:#131a24;color:var(--fg);border:1px solid #243042;border-radius:8px;padding:6px 10px}
button:disabled{opacity:.5}
.sep{width:1px;height:24px;background:#223046}
.pill{padding:2px 8px;border:1px solid #2a3a52;border-radius:999px;font-size:12px;color:#a9c8ff;margin-left:6px}

#stage{display:flex;flex-direction:column;flex:1;min-height:0}
#canvas-wrap{position:relative;flex:1;min-height:0}
#log{position:absolute;bottom:10px;right:10px;font-size:12px;color:#9bb3d4;pointer-events:none;max-width:60vw;text-align:right}
footer{height:40px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:12px;color:#9bb3d4}

/* è™›æ“¬piano */
#vkbBottom{display:block;border-top:1px solid #1b2740;background:rgba(8,12,18,.95)}
#vkbBar{display:flex;align-items:center;gap:12px;padding:10px 14px;color:#9bb3d4;font-size:12px}
.vkbd-wrap{position:relative;background:#0f1622}
#vkbd{position:relative;user-select:none;touch-action:none;width:100%;height:220px;border-top:1px solid #1b2740}
.white-keys{position:absolute;inset:0;display:flex;align-items:stretch}
.key{position:relative;box-sizing:border-box;cursor:pointer}
.key.white{flex:1 0 auto;border-right:1px solid #223046;background:#e7eefc;height:100%}
.key.white:last-child{border-right:none}
.key.white.on{background:#cfe0ff}
.key.white.playing{background:#bcd1fb;transform:translateY(1px)}
.black-keys{position:absolute;inset:0;pointer-events:none}
.key.black{position:absolute;width:calc(100%/14*0.6);height:62%;top:0;background:#1c2331;border:1px solid #2a3a52;border-radius:0 0 6px 6px;z-index:5;pointer-events:auto}
.key.black.on{background:#2b3954}
.key.black.playing{background:#3b4f78;transform:translateY(1px)}

/* æ‹‰é‚£å€‹æ¢ */
#scrubWrap{display:flex;align-items:center;gap:10px;min-width:260px;flex:1}
#scrub{width:100%;height:6px;border-radius:999px;background:#1a2435;outline:none;border:1px solid #243042;-webkit-appearance:none;appearance:none}
#scrub:disabled{opacity:.5}
#scrub::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#f6c177;border:1px solid #774;cursor:pointer;margin-top:-4px}
#scrub::-moz-range-thumb{width:14px;height:14px;border-radius:50%;background:#f6c177;border:1px solid #774;cursor:pointer}
</style>
</head>
<body>
<header>
  <input id="file" type="file" accept=".mid,.midi"/>
  <button id="play" disabled>â–¶ï¸ æ’­æ”¾</button>
  <button id="stop" disabled>â¹ åœæ­¢</button>
  <button id="unlock">ğŸ”“ å•Ÿç”¨éŸ³è¨Š</button>

  <span class="sep"></span>
  <label>æ¨¡å¼ï¼š
    <select id="mode">
      <option value="pulse" selected>åœˆåœˆ</option>
      <option value="piano">Piano Roll</option>
      <option value="stars">æ˜Ÿå¡µ</option>
      <option value="field">ç²’å­</option>
    </select>
  </label>
  <span id="pianoControls" style="display:none">
    <label>px/s
      <input id="pxPerSec" type="range" min="80" max="360" value="180"/>
      <span id="pxPerSecVal" class="pill">180</span>
    </label>
  </span>

  <span class="sep"></span>
  <!-- é€²åº¦æ‹–æ›³é•·æ¢ -->
  <div id="scrubWrap" title="æ‹–æ›³æˆ–é»æ“Šä»¥è·³åˆ°æŒ‡å®šæ™‚é–“">
    <input id="scrub" type="range" min="0" value="0" step="0.001" disabled />
    <span id="scrubVal" class="pill">0:00</span>
  </div>

  <span class="sep"></span>
  <label style="display:flex;align-items:center;gap:8px">
    <input id="toggleVKB" type="checkbox" checked />
    é¡¯ç¤ºä¸‹æ–¹è™›æ“¬é‹¼ç´
  </label>
</header>

<div id="stage">
  <div id="canvas-wrap"></div>

  <div id="vkbBottom" aria-hidden="false">
    <div id="vkbBar">
      ğŸ¹ è™›æ“¬é‹¼ç´ <span id="vkbRange" class="pill">C3â€“B4</span>
      <label>é«˜åº¦
        <input id="vkbHeight" type="range" min="140" max="320" value="220"/>
        <span id="vkbHeightVal" class="pill">220</span>
      </label>
      <label>èµ·å§‹å…«åº¦
        <input id="octaveStart" type="range" min="2" max="6" value="3"/>
        <span id="octaveStartVal" class="pill">3</span>
      </label>
      <label>å…«åº¦æ•¸
        <input id="octaveCount" type="range" min="1" max="4" value="2"/>
        <span id="octaveCountVal" class="pill">2</span>
      </label>
    </div>
    <div class="vkbd-wrap"><div id="vkbd"></div></div>
  </div>

  <div id="log">ç‹€æ…‹ï¼šä¸€ä¸å°å¿ƒå°±æœƒå£æ‰</div>
</div>

<footer>ğŸµ Tone.js Â· @tonejs/midi Â· p5.js</footer>

<script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.28/build/Midi.js"></script>
<script src="https://cdn.jsdelivr.net/npm/p5@1.9.4/lib/p5.min.js"></script>

<script>
/* ---------- éŒ¯èª¤å¯è¦–åŒ– ---------- */
window.addEventListener('error', e => { document.querySelector('#log').textContent = 'âš ï¸ JS Error: ' + (e.message || e.error); });

/* ---------- DOM åƒç…§ ---------- */
const $=s=>document.querySelector(s);
const file=$('#file'), play=$('#play'), stopBtn=$('#stop'), unlockBtn=$('#unlock'), log=$('#log');
const modeSel=$('#mode'), pxPerSecEl=$('#pxPerSec'), pxPerSecVal=$('#pxPerSecVal'), pianoControls=$('#pianoControls');
const toggleVKB=$('#toggleVKB'), vkbBottom=$('#vkbBottom'), vkbHeight=$('#vkbHeight'), vkbHeightVal=$('#vkbHeightVal');
const vkbdEl=$('#vkbd'), vkbRange=$('#vkbRange'), octaveStart=$('#octaveStart'), octaveCount=$('#octaveCount');
const octaveStartVal=$('#octaveStartVal'), octaveCountVal=$('#octaveCountVal');
const scrub=$('#scrub'), scrubVal=$('#scrubVal');

/* ---------- å…¨åŸŸç‹€æ…‹ ---------- */
let midi=null, parts=[], synths=[], liveSynth=null;
let started=false, liveClockStart=null, isScrubbing=false, usePreview=false, previewSec=0;

/* ---------- æ™‚é–“è»¸ ---------- */
function timelineSeconds(){
  if (Tone.Transport.state === 'started') return Tone.Transport.seconds;
  if (usePreview) return previewSec;
  if (liveClockStart === null) liveClockStart = Tone.now();
  return Tone.now() - liveClockStart;
}
function resetLiveClock(){ liveClockStart = Tone.now(); }

/* ---------- å•Ÿç”¨éŸ³è¨Š ---------- */
async function ensureAudio(){
  if (started) return true;
  try{
    await Tone.start();
    if (Tone.getContext().rawContext.state !== 'running'){
      await Tone.getContext().rawContext.resume();
    }
    started = true;
    if (!liveSynth) liveSynth = new Tone.PolySynth(Tone.Synth).toDestination();
    log.textContent = 'âœ… éŸ³è¨Šå·²å•Ÿç”¨ã€‚';
    return true;
  }catch(err){ log.textContent = 'âŒ ç„¡æ³•å•Ÿç”¨éŸ³è¨Šï¼š' + err; return false; }
}
unlockBtn.addEventListener('click', ensureAudio);
document.addEventListener('pointerdown', ()=>{ if(!started) ensureAudio(); }, {once:false});

/* ---------- UI åˆ‡æ› ---------- */
modeSel.onchange=()=>{ V.mode=modeSel.value; pianoControls.style.display = (V.mode==='piano') ? 'inline-flex' : 'none'; };
pxPerSecEl.oninput=()=>{ pxPerSecVal.textContent = pxPerSecEl.value; };
toggleVKB.onchange=()=>{ vkbBottom.style.display = toggleVKB.checked ? 'block' : 'none'; };

/* ---------- è¼‰å…¥ MIDI ---------- */
file.onchange=async e=>{
  const f=e.target.files[0]; if(!f) return;
  log.textContent="è®€å–ä¸­...";
  try{
    midi=new Midi(await f.arrayBuffer());
  }catch(err){ log.textContent="âŒ è§£æå¤±æ•—ï¼š"+err; return; }

  // æ¸…ç†èˆŠçš„
  parts.forEach(p=>p.dispose()); parts=[]; synths.forEach(s=>s.dispose()); synths=[];

  synths=midi.tracks.map(()=>new Tone.PolySynth(Tone.Synth).toDestination());
  if(!liveSynth) liveSynth=new Tone.PolySynth(Tone.Synth).toDestination();

  V.notesAll=[]; let gmin=999,gmax=0;
  const bpm=(midi.header.tempos[0]?.bpm)||120;
  const sig=midi.header.timeSignatures[0]?.timeSignature || midi.header.timeSignatures[0] || [4,4];
  const [num,den]=sig; V.barSeconds=(60/bpm)*4*(num/den);

  midi.tracks.forEach((t,ti)=>{
    const events = t.notes.map(n=>({time:n.time, dur:n.duration, end:n.time+n.duration, midi:n.midi, vel:n.velocity, name:n.name}));
    events.forEach(ev=>{
      V.notesAll.push(ev);
      gmin=Math.min(gmin,ev.midi); gmax=Math.max(gmax,ev.midi);
    });
    const part=new Tone.Part((time,ev)=>{
      synths[ti].triggerAttackRelease(Tone.Frequency(ev.midi,'midi'), ev.dur, time, ev.vel);
      pushVisual(ev.midi, ev.vel, ev.dur);
      flashKey(ev.midi, ev.dur);
    }, events).start(0);
    part.loop=false; parts.push(part);
  });
  if(gmin<999){ V.midiMin=Math.max(21,gmin-2); V.midiMax=Math.min(108,gmax+2); }
  V.notesAll.sort((a,b)=>a.time-b.time);

  // å•Ÿç”¨é€²åº¦æ¢
  const total = V.notesAll.length ? Math.max(...V.notesAll.map(n=>n.end)) : 0;
  V.totalSeconds = total;
  scrub.max = (total||0).toFixed(3);
  scrub.value = 0;
  scrub.step = '0.001';
  scrub.disabled = !(total>0);
  scrubVal.textContent = fmtTime(0);

  play.disabled=false; stopBtn.disabled=false;
  log.textContent="âœ… è®€å–å®Œæˆï¼š"+f.name+"ï¼ˆæŒ‰ â–¶ï¸ æ’­æ”¾ æˆ–ç›´æ¥å½ˆä¸‹æ–¹é‹¼ç´ï¼‰";
};

/* ---------- æ’­æ”¾æ§åˆ¶ ---------- */
play.onclick=async()=>{
  if(!(await ensureAudio())) return;
  const startAt = scrub.disabled ? 0 : parseFloat(scrub.value)||0;
  Tone.Transport.stop();
  Tone.Transport.seconds = startAt;
  Tone.Transport.start("+0.03");
  usePreview = false;
  resetLiveClock();
  log.textContent="â–¶ï¸ æ’­æ”¾ä¸­";
};
stopBtn.onclick=()=>{
  Tone.Transport.stop();
  usePreview = true;
  previewSec = parseFloat(scrub.value)||0;
  resetLiveClock();
  log.textContent="â¹ åœæ­¢";
};

/* ---------- p5çš„éƒ¨åˆ† ---------- */
const V={ notesAll:[], activeNotes:[], liveOverlay:[], particles:[], mode:'pulse', midiMin:48, midiMax:83, barSeconds:2, totalSeconds:0 };

new p5(p=>{
  let W, H;
  const stage = document.querySelector('#stage');

  function sizeFromContainer(){
    W = stage.clientWidth;
    const vkbH = (vkbBottom.style.display==='block') ? vkbBottom.offsetHeight : 0;
    H = Math.max(120, stage.clientHeight - vkbH);
  }

  p.setup=()=>{ sizeFromContainer(); const c=p.createCanvas(W,H); c.parent('canvas-wrap'); };
  p.windowResized=()=>{ sizeFromContainer(); p.resizeCanvas(W,H); };
  new ResizeObserver(()=>{ sizeFromContainer(); p.resizeCanvas(W,H); }).observe(vkbBottom);

  p.draw=()=>{
    p.background(11,15,20);
    if(V.mode==='pulse') drawPulse(p,W,H);
    else if(V.mode==='piano') drawPianoRoll(p,W,H);
    else if(V.mode==='stars') drawStars(p,W,H);
    else if(V.mode==='field') drawField(p,W,H);
  };

  function drawPulse(p,w,h){
    const now = Tone.now();
    const recent = V.activeNotes.filter(n => (now - n.time) < 0.14);
    let avgVel = recent.length ? recent.reduce((a,b)=>a+b.vel,0)/recent.length : 0;
    const baseR = Math.min(w, h) * 0.18;
    const r = baseR + recent.length * 12 + avgVel * 90;

    p.noFill(); p.stroke(121,192,255); p.strokeWeight(4);
    p.circle(w/2, h/2, r*2);

    for(const n of recent){
      const hue = (n.midi % 12) * 30;
      const [rC,gC,bC] = hslToRgb(hue/360, 0.6, 0.6);
      const a = Math.round(150 + (n.vel||0) * 100);
      p.stroke(rC,gC,bC, a); p.strokeWeight(2);
      const rr = baseR*0.5 + (n.midi%12)*5 + (n.vel||0)*8;
      p.circle(w/2, h/2, rr*2);
    }
  }

  function drawPianoRoll(p,w,h){
    const pxPerSec = parseInt(pxPerSecEl.value,10);
    const playX = Math.floor(w/3);
    const curSec = timelineSeconds();
    const winStart = curSec - playX/pxPerSec;
    const winEnd = winStart + w/pxPerSec;

    const rows = Math.max(1, V.midiMax - V.midiMin + 1);
    const rowH = h / rows;
    const leftKeyW = Math.max(56, Math.min(80, Math.round(w*0.08)));

    // å·¦å´éµç›¤
    for(let m=V.midiMin; m<=V.midiMax; m++){
      const isBlack = [1,3,6,8,10].includes(m % 12);
      const yy = (V.midiMax - m) * rowH;
      p.noStroke(); p.fill(isBlack ? 28 : 235, isBlack ? 30 : 240, isBlack ? 36 : 248);
      if (!isBlack) p.rect(0, yy, leftKeyW, rowH+1);
    }
    for(let m=V.midiMin; m<=V.midiMax; m++){
      const isBlack = [1,3,6,8,10].includes(m % 12);
      if(!isBlack) continue;
      const yy = (V.midiMax - m) * rowH;
      p.noStroke(); p.fill(24,28,36);
      p.rect(0, yy, Math.floor(leftKeyW*0.6), rowH+1, 2);
    }
    p.fill(12,18,28, 230); p.rect(0, 0, leftKeyW, h);
    p.textAlign(p.RIGHT, p.CENTER); p.textSize(Math.min(14, rowH*0.9)); p.fill(200,220,245);
    for(let m=V.midiMin; m<=V.midiMax; m++){
      if (m % 12 === 0) {
        const yy = (V.midiMax - m) * rowH + rowH/2;
        p.text(midiToName(m), leftKeyW - 6, yy);
      }
    }

    // å³å´
    const vw = w - leftKeyW; p.push(); p.translate(leftKeyW, 0);

    // æ©«ç·š
    p.stroke(40,56,80,160); p.strokeWeight(1);
    for(let m=V.midiMin; m<=V.midiMax; m++){
      const y = Math.round((V.midiMax - m)*rowH)+0.5;
      p.line(0,y,vw,y);
    }
    // ç›´ç·šï¼ˆæ¯ç§’ï¼›å°ç¯€åŠ ç²—ï¼‰
    const t0 = Math.floor(winStart);
    for(let t=t0; t<=winEnd; t++){
      const x = (t - winStart)*pxPerSec + 0.5;
      const barLen = V.barSeconds || 2;
      if (Math.abs((t % barLen)) < 1e-3) { p.stroke(90,140,220,220); p.strokeWeight(2); }
      else { p.stroke(44,64,88,180); p.strokeWeight(1); }
      p.line(x,0,x,h);
    }

    // MIDI éŸ³ç¬¦
    p.noStroke();
    for(const n of V.notesAll){
      if(n.end < winStart || n.time > winEnd) continue;
      const x = (n.time - winStart) * pxPerSec;
      const wRect = Math.max(2, n.dur * pxPerSec);
      const y = (V.midiMax - n.midi) * rowH + 2;
      const hue = (n.midi % 12) * 30;
      const [rC,gC,bC] = hslToRgb(hue/360, 0.55, 0.62);
      const alpha = Math.round(140 + (n.vel||0)*100);
      p.fill(rC,gC,bC, alpha);
      p.rect(x, y, wRect, rowH-4, 3);

      if (wRect > 34 && rowH > 12){
        p.fill(12,18,28, 230);
        p.textSize(Math.min(12, rowH-4));
        p.textAlign(p.LEFT, p.CENTER);
        p.text(n.name || midiToName(n.midi), x+4, y + (rowH-4)/2);
      }
    }

    // Live 
    for(let i=V.liveOverlay.length-1;i>=0;i--){
      const ln = V.liveOverlay[i];
      const st = ln.start, ed = (ln.end ?? timelineSeconds());
      if (ed < winStart) { V.liveOverlay.splice(i,1); continue; }
      const x = (st - winStart) * pxPerSec;
      const wRect = Math.max(2, (ed - st) * pxPerSec);
      const y = (V.midiMax - ln.midi) * rowH + 4;
      p.noStroke();
      p.fill(246,193,119, 220);
      p.rect(x, y, wRect, rowH-8, 4);
    }

    // æ’­æ”¾æŒ‡é‡
    p.stroke(246,193,119); p.strokeWeight(2);
    p.line((playX)+0.5, 0, (playX)+0.5, h);
    p.pop();
  }

  function drawStars(p,w,h){
    const fresh = V.activeNotes.splice(0);
    for(const n of fresh){ V.particles.push({x:w/2,y:h/2,vx:p.random(-4,4),vy:p.random(-4,4),life:1}); }
    for(let i=V.particles.length-1;i>=0;i--){
      const pt=V.particles[i]; pt.x+=pt.vx; pt.y+=pt.vy; pt.life-=0.03;
      if(pt.life<=0){ V.particles.splice(i,1); continue; }
      p.noStroke(); p.fill(121,192,255, pt.life*255); p.circle(pt.x,pt.y,6);
    }
  }

  const field=Array.from({length:300},()=>({x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight*0.7,vx:0,vy:0}));
  function drawField(p,w,h){
    for(const f of field){
      f.x+=f.vx; f.y+=f.vy;
      if(f.x<0||f.x>w)f.vx*=-1; if(f.y<0||f.y>h)f.vy*=-1;
      f.vx*=0.98; f.vy*=0.98;
      p.noStroke(); p.fill(121,192,255,200); p.circle(f.x,f.y,2);
    }
    if(V.activeNotes.length>0){ field.forEach(pt=>{pt.vx+=Math.random()*4-2; pt.vy+=Math.random()*4-2;}); V.activeNotes=[]; }
  }
});

/* ---------- è™›æ“¬é‹¼ç´ ---------- */
const WHITE_PCS=[0,2,4,5,7,9,11];
const BLACK_PCS=new Set([1,3,6,8,10]);
const pressed=new Map();

/* å…¨åŸŸï¼šçµ¦è™›æ“¬éµç›¤ & p5 å…±ç”¨ */
function midiToName(m){
  const names=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const octave=Math.floor(m/12)-1; return names[m%12]+octave;
}

vkbHeight.addEventListener('input', ()=>{
  vkbHeightVal.textContent = vkbHeight.value;
  document.querySelector('.vkbd-wrap').style.height = vkbHeight.value + 'px';
  vkbdEl.style.height = vkbHeight.value + 'px';
});

function buildKeyboard(){
  vkbdEl.innerHTML='';
  document.querySelector('.vkbd-wrap').style.height = vkbHeight.value + 'px';
  vkbdEl.style.height = vkbHeight.value + 'px';

  const oStart=parseInt(octaveStart.value,10);
  const oCount=parseInt(octaveCount.value,10);
  octaveStartVal.textContent=oStart; octaveCountVal.textContent=oCount;

  const midiStart = 12*(oStart+1);            // C(oStart)
  const midiEnd   = 12*(oStart+oCount+1) - 1; // B of last octave
  vkbRange.textContent = midiToName(midiStart)+'â€“'+midiToName(midiEnd);

  // æ²’è¼‰å…¥ MIDI æ™‚ï¼Œç”¨éµç›¤ç¯„åœç•¶ä½œ Piano Roll éŸ³åŸŸ
  if(!midi){ V.midiMin = midiStart; V.midiMax = midiEnd; V.barSeconds = 2; }

  const whiteWrap=document.createElement('div'); whiteWrap.className='white-keys';
  const blackWrap=document.createElement('div'); blackWrap.className='black-keys';
  vkbdEl.append(whiteWrap); vkbdEl.append(blackWrap);

  const whites=[];
  for(let m=midiStart; m<=midiEnd; m++){
    if(!WHITE_PCS.includes(m%12)) continue;
    const el=document.createElement('div');
    el.className='key white'; el.dataset.midi=m;
    addKeyEvents(el);
    whiteWrap.appendChild(el);
    whites.push({midi:m});
  }
  const whiteWidth = 100/whites.length;
  for(let i=0;i<whites.length;i++){
    const m = whites[i].midi;
    const pc = (m%12);
    if([0,2,5,7,9].includes(pc)){
      const blackMidi = m+1; if(blackMidi>midiEnd || !BLACK_PCS.has(blackMidi%12)) continue;
      const el=document.createElement('div');
      el.className='key black'; el.dataset.midi=blackMidi;
      const leftPct = (i+1)*whiteWidth - whiteWidth*0.35;
      el.style.left = `calc(${leftPct}% - 8px)`;
      addKeyEvents(el);
      blackWrap.appendChild(el);
    }
  }
}
function addKeyEvents(el){
  el.addEventListener('pointerdown',onKeyDown,{passive:false});
  el.addEventListener('pointerenter',e=>{ if(e.buttons===1) onKeyDown(e);});
  el.addEventListener('pointerup',onKeyUp);
  el.addEventListener('pointercancel',onKeyUp);
  el.addEventListener('pointerleave',onKeyUp);
}

async function onKeyDown(e){
  e.preventDefault();
  const ok = await ensureAudio(); if(!ok) return;

  const el=e.target.closest('.key'); if(!el) return;
  const midiNum=parseInt(el.dataset.midi,10);
  const ptr = e.pointerId || 'mouse';
  if(!pressed.has(ptr)) pressed.set(ptr,new Set());
  const set=pressed.get(ptr);
  if(set.has(midiNum)) return;
  set.add(midiNum);

  el.classList.add('playing','on');
  const freq = Tone.Frequency(midiNum,'midi');
  liveSynth.triggerAttack(freq, undefined, 0.95);

  // è¦–è¦º & Piano Roll overlay é€™è£¡è‚šå­æœ‰é»ç—›?
  pushVisual(midiNum, 0.95, 0.25);
  const t = timelineSeconds();
  V.liveOverlay.push({midi:midiNum, start:t, end:null});

  el.setPointerCapture && el.setPointerCapture(e.pointerId);
}
function onKeyUp(e){
  const el=e.target.closest('.key'); if(!el) return;
  const midiNum=parseInt(el.dataset.midi,10);
  const ptr = e.pointerId || 'mouse';
  const set=pressed.get(ptr); if(!set) return;
  if(set.has(midiNum)){
    set.delete(midiNum);
    el.classList.remove('playing');
    liveSynth && liveSynth.triggerRelease(Tone.Frequency(midiNum,'midi'));

    const now = timelineSeconds();
    for(let i=V.liveOverlay.length-1;i>=0;i--){
      if(V.liveOverlay[i].midi===midiNum && V.liveOverlay[i].end===null){
        V.liveOverlay[i].end = now; break;
      }
    }
    let stillOn=false;
    pressed.forEach(s=>{ if(s.has(midiNum)) stillOn=true; });
    if(!stillOn) el.classList.remove('on');
  }
}

/* ---------- è¦–è¦ºäº‹ä»¶/éµç›¤é«˜äº® ---------- */
function pushVisual(midi, vel, dur){
  V.activeNotes.push({time:Tone.now(), midi, vel:vel||0.8, dur:dur||0.2, track:-1});
}
function flashKey(midi, dur=0.15){
  const key = vkbdEl.querySelector(`.key[data-midi="${midi}"]`);
  if(!key) return;
  key.classList.add('on','playing');
  setTimeout(()=>key.classList.remove('playing'), Math.max(80, dur*1000*0.6));
  setTimeout(()=>{
    let stillOn=false;
    pressed.forEach(s=>{ if(s.has(midi)) stillOn=true; });
    if(!stillOn) key.classList.remove('on');
  }, Math.max(120, dur*1000));
}

/* ---------- é€²åº¦æ¢äº‹ä»¶ ---------- */
setInterval(()=>{
  if (Tone.Transport.state === 'started' && !isScrubbing && !scrub.disabled){
    const t = Math.min(Tone.Transport.seconds, V.totalSeconds||Tone.Transport.seconds);
    scrub.value = t.toFixed(3);
    scrubVal.textContent = fmtTime(t);
  }
}, 50);

scrub.addEventListener('input', ()=>{
  isScrubbing = true;
  const t = parseFloat(scrub.value)||0;
  scrubVal.textContent = fmtTime(t);
  if (Tone.Transport.state !== 'started'){
    usePreview = true;
    previewSec = t;
  }
});

['change','pointerup','mouseup','touchend'].forEach(evt=>{
  scrub.addEventListener(evt, ()=>{
    const t = parseFloat(scrub.value)||0;
    if (Tone.Transport.state === 'started'){
      Tone.Transport.seconds = t;
      resetLiveClock();
    }else{
      usePreview = true;
      previewSec = t;
    }
    isScrubbing = false;
    scrubVal.textContent = fmtTime(t);
  });
});

function fmtTime(sec){
  sec = Math.max(0, Math.floor(sec));
  const m = Math.floor(sec/60), s = sec%60;
  return `${m}:${s.toString().padStart(2,'0')}`;
}

/* ---------- åˆå§‹åŒ– ---------- */
vkbHeight.addEventListener('input', ()=>{
  vkbHeightVal.textContent=vkbHeight.value;
  document.querySelector('.vkbd-wrap').style.height=vkbHeight.value+'px';
  vkbdEl.style.height=vkbHeight.value+'px';
});
octaveStart.addEventListener('input', buildKeyboard);
octaveCount.addEventListener('input', buildKeyboard);
buildKeyboard();

/* ---------- å°å·¥å…· ---------- */
function hslToRgb(h, s, l){
  const a = s * Math.min(l, 1 - l);
  const f = (n, k=(n + h*12)%12) => l - a * Math.max(Math.min(k-3, 9-k, 1), -1);
  return [Math.round(f(0)*255), Math.round(f(8)*255), Math.round(f(4)*255)];
}
</script>
</body>
</html>
